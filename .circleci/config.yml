---
version: 2

workflows:
  version: 2
  main:
    jobs:
    - test_7390x
#    - test_7490x
#    - test_8090x
#    - test_7391x
#    - test_7491x
#    - test_8091x
#    - test_7392x
#    - test_7492x
#    - test_8092x
  # Run nightly tests every day 8 AM.
  nightly:
    jobs:
    - test_7390x
    - test_7490x
    - test_8090x
    - test_7391x
    - test_7491x
    - test_8091x
    - test_7392x
    - test_7492x
    - test_8092x
    triggers:
    - schedule:
        # Weekday (22=10pm UTC). Evaluates to 8am AEST.
        cron: "0 22 * * *"
        filters:
          branches:
            only:
            - 8.x-1.x
            - 8.x-2.x

jobs:

  test: &test
    docker:
    - image: wodby/php:${PHP_TAG}
      name: php
      environment:
        MODULE_NAME: dynamic_entity_reference
        SIMPLETEST_BASE_URL: http://apache
        SIMPLETEST_DB: mysql://drupal:drupal@mariadb/local
        BROWSERTEST_OUTPUT_FILE: /var/www/html/sites/simpletest/browser_output/browser_output.html
        BROWSERTEST_OUTPUT_DIRECTORY: /var/www/html/sites/simpletest/browser_output
        MINK_DRIVER_ARGS_WEBDRIVER: '["chrome", null, "http:\/\/chrome:4444\/wd\/hub"]'
        PHP_SENDMAIL_PATH: /usr/sbin/sendmail -t -i -S mailhog:1025
        DB_HOST: mariadb
        DB_USER: drupal
        DB_PASSWORD: drupal
        DB_NAME: local
        PHP_FPM_USER: wodby
        PHP_FPM_GROUP: wodby
        PHP_XDEBUG: 0
    - image: mariadb
      name: mariadb
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: local
        MYSQL_USER: drupal
        MYSQL_PASSWORD: drupal
    - image: wodby/apache
      command:
      - httpd -D FOREGROUND
      - sleep 5s
      - httpd -k restart
      name: apache
      environment:
        APACHE_LOG_LEVEL: debug
        APACHE_BACKEND_HOST: localhost
        APACHE_VHOST_PRESET: php
        APACHE_DOCUMENT_ROOT: /var/www/html
    - image: selenium/standalone-chrome:latest
      name: chrome
    working_directory: /var/www/html
    steps:
    - add_ssh_keys:
        fingerprints:
          - a6:e4:76:63:c3:bf:5e:a5:cf:0e:0b:a1:7e:c9:c0:21
    - run:
        name: Download specified drupal version
        command: |
          git clone --depth 1 --branch ${DRUPAL_BRANCH} \
            https://git.drupalcode.org/project/drupal.git .
          git log -1 --oneline
    - run:
        name: Fetch drupal dependencies and module test dependencies
        command: |
          composer install --prefer-dist --no-progress
          composer require drupal/diff:1.x-dev --no-progress

    - checkout:
        path: modules/${MODULE_NAME}
    - run:
        name: Lint PHP against Drupal coding standards
        command: |
          vendor/bin/phpcs \
            --standard=vendor/drupal/coder/coder_sniffer/Drupal \
            --extensions=php,module,inc,install,test,profile,theme,css,info \
            --ignore=*.md \
            modules/${MODULE_NAME}

    - run:
        name: Setup Directories
        command: |
          mkdir -p sites/default/files/tmp sites/default/private sites/simpletest/browser_output build/logs/phpunit
          chmod -R 2775 sites/default/files sites/default/private sites/simpletest build/logs
          touch sites/simpletest/browser_output/browser_output.html
          chown -R wodby:wodby /var/www/html

    - run:
        name: Run unit tests
        command: |
          ./vendor/bin/phpunit -v -c ./core/phpunit.xml.dist --log-junit build/logs/phpunit/phpunit.xml modules/${MODULE_NAME}
    - store_test_results:
        path: build/logs
    - store_artifacts:
        path: sites/simpletest/browser_output

  test_7390x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.0.x
    - PHP_TAG: 7.3
  test_7490x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.0.x
    - PHP_TAG: 7.4
  test_8090x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.0.x
    - PHP_TAG: 8.0
  test_7391x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.1.x
    - PHP_TAG: 7.3
  test_7491x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.1.x
    - PHP_TAG: 7.4
  test_8091x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.1.x
    - PHP_TAG: 8.0
  test_7392x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.2.x
    - PHP_TAG: 7.3
  test_7492x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.2.x
    - PHP_TAG: 7.4
  test_8092x:
    <<: *test
    environment:
    - DRUPAL_BRANCH: 9.2.x
    - PHP_TAG: 8.0
